<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL è¯­æ³•æ ‘å¯è§†åŒ–å·¥å…·</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .controls {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .sql-input-section {
            margin-bottom: 15px;
        }
        
        .sql-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        #sql-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        
        #sql-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .view-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 0 10px;
        }
        
        .view-toggle label {
            font-weight: 500;
            color: #333;
        }
        
        .view-toggle select {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .view-toggle select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .info-section {
            margin-bottom: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }
        
        .ast-explanation h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .ast-explanation p {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .explanation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .explanation-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .explanation-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .explanation-item strong {
            display: block;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .explanation-item span {
            color: #6c757d;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .control-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .parse-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .tree-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .view-mode-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .view-mode-selector label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-size: 13px;
        }
        
        .radio-option:hover {
            background-color: #f8f9fa;
        }
        
        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked + span {
            color: #007bff;
            font-weight: 600;
        }
        
        .radio-option span {
            color: #495057;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #545b62;
        }
        
        #tree-container {
            width: 100%;
            height: 600px;
            overflow: auto;
            position: relative;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node circle {
            fill: #fff;
            stroke: #4a90e2;
            stroke-width: 2px;
            transition: all 0.3s ease;
        }
        
        .node.selected circle {
            fill: #4a90e2;
            stroke: #2c5aa0;
            stroke-width: 3px;
        }
        
        .node:hover circle {
            fill: #e3f2fd;
            stroke: #1976d2;
            stroke-width: 3px;
        }
        
        .node text {
            font: 12px sans-serif;
            fill: #333;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }
        
        .node.selected text {
            fill: #333;
            font-weight: bold;
        }
        
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
            transition: stroke 0.3s ease;
        }
        
        .link.highlighted {
            stroke: #4a90e2;
            stroke-width: 3px;
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 20px;
            display: none;
            z-index: 1000;
        }
        
        .info-panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 8px;
        }
        
        .info-item {
            margin-bottom: 10px;
        }
        
        .info-label {
            font-weight: bold;
            color: #666;
            display: inline-block;
            width: 80px;
        }
        
        .info-value {
            color: #333;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SQL è¯­æ³•æ ‘å¯è§†åŒ–å·¥å…·</h1>
            <p>ç›´è§‚ç†è§£ SQL è§£æè¿‡ç¨‹ï¼ŒæŸ¥çœ‹æŠ½è±¡è¯­æ³•æ ‘ç»“æ„</p>
        </div>
        
        <div class="info-section">
            <div class="ast-explanation">
                <h3>ğŸ“– ä»€ä¹ˆæ˜¯ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Ÿ</h3>
                <p><strong>AST (Abstract Syntax Tree)</strong> æ˜¯ç¼–è¯‘å™¨å°†æºä»£ç è½¬æ¢ä¸ºç»“æ„åŒ–è¡¨ç¤ºçš„ä¸­é—´å½¢å¼ã€‚å¯¹äºSQLè¯­å¥ï¼ŒASTå±•ç¤ºäº†æŸ¥è¯¢çš„è¯­æ³•ç»“æ„ï¼Œå¸®åŠ©ç†è§£æ•°æ®åº“å¦‚ä½•è§£æå’Œå¤„ç†ä½ çš„SQLä»£ç ã€‚</p>
                <div class="explanation-grid">
                    <div class="explanation-item">
                        <strong>ğŸŒ³ è¯­æ³•ç»“æ„</strong>
                        <span>å±•ç¤ºSQLè¯­å¥çš„å±‚æ¬¡åŒ–è¯­æ³•ç»„ç»‡</span>
                    </div>
                    <div class="explanation-item">
                        <strong>âš¡ æ‰§è¡Œè®¡åˆ’</strong>
                        <span>æ˜¾ç¤ºæ•°æ®åº“å¼•æ“çš„å®é™…æ‰§è¡Œé¡ºåº</span>
                    </div>
                    <div class="explanation-item">
                        <strong>ğŸ” è°ƒè¯•åŠ©æ‰‹</strong>
                        <span>å¸®åŠ©å‘ç°SQLè¯­å¥çš„ç»“æ„é—®é¢˜</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="sql-input-section">
                <label for="sql-input">è¾“å…¥ SQL è¯­å¥ï¼š</label>
                <textarea id="sql-input" placeholder="è¾“å…¥æ‚¨çš„ SQL è¯­å¥ï¼Œä¾‹å¦‚ï¼šSELECT id, name FROM users LEFT JOIN orders ON users.id = orders.user_id WHERE age > 18;" rows="3"></textarea>
                <button class="btn" onclick="parseSQL()">ğŸš€ è§£æ SQL</button>
            </div>
            <div class="control-buttons">
                <div class="view-mode-selector">
                    <label>å¯è§†åŒ–æ¨¡å¼ï¼š</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="viewMode" value="both" checked onchange="switchViewMode()">
                            <span>å®Œæ•´åˆ†æ</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="viewMode" value="ast" onchange="switchViewMode()">
                            <span>è¯­æ³•ç»“æ„</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="viewMode" value="execution" onchange="switchViewMode()">
                            <span>æ‰§è¡Œè®¡åˆ’</span>
                        </label>
                    </div>
                </div>
                <button class="btn secondary" onclick="expandAll()">å±•å¼€æ‰€æœ‰èŠ‚ç‚¹</button>
                <button class="btn secondary" onclick="collapseAll()">æ”¶èµ·æ‰€æœ‰èŠ‚ç‚¹</button>
                <button class="btn secondary" onclick="resetZoom()">é‡ç½®è§†å›¾</button>
                <button class="btn secondary" onclick="toggleDetails()">åˆ‡æ¢è¯¦æƒ…é¢æ¿</button>
            </div>
        </div>
        
        <div id="tree-container">
            <div class="loading">æ­£åœ¨åŠ è½½ AST æ•°æ®...</div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="node-count">0</div>
                <div class="stat-label">èŠ‚ç‚¹æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="depth-count">0</div>
                <div class="stat-label">æœ€å¤§æ·±åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="selected-node">æ— </div>
                <div class="stat-label">é€‰ä¸­èŠ‚ç‚¹</div>
            </div>
        </div>
    </div>
    
    <div class="info-panel" id="info-panel">
        <button class="close-btn" onclick="closeInfoPanel()">&times;</button>
        <h3>èŠ‚ç‚¹è¯¦æƒ…</h3>
        <div id="node-details">
            <div class="info-item">
                <span class="info-label">ä½¿ç”¨è¯´æ˜:</span>
                <span class="info-value">ç‚¹å‡»æ ‘å½¢å›¾ä¸­çš„èŠ‚ç‚¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span>
            </div>
            <div class="info-item">
                <span class="info-label">åŠŸèƒ½æç¤º:</span>
                <span class="info-value">â€¢ ç‚¹å‡»èŠ‚ç‚¹å¯å±•å¼€/æ”¶èµ·å­èŠ‚ç‚¹<br>â€¢ æ‹–æ‹½å¯ç§»åŠ¨è§†å›¾<br>â€¢ æ»šè½®å¯ç¼©æ”¾</span>
            </div>
        </div>
    </div>
    
    <script>
        let treeData = null;
        let svg = null;
        let g = null;
        let tree = null;
        let root = null;
        let selectedNode = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAST();
        });
        
        function loadAST() {
            // ç§»é™¤æ–‡ä»¶åŠ è½½åŠŸèƒ½ï¼Œæ”¹ä¸ºæ˜¾ç¤ºé»˜è®¤ç¤ºä¾‹
            const defaultSQL = `SELECT id, name FROM users 
LEFT JOIN orders ON users.id = orders.user_id 
WHERE age > 18 AND name = 'å¼ ä¸‰' AND orders.id IS NULL 
GROUP BY id, name 
HAVING count(*) = 0;`;
            parseClientSide(defaultSQL);
        }
        
        function showError(message) {
            document.getElementById('tree-container').innerHTML = 
                `<div class="error-message">${message}</div>`;
        }
        
        function initializeTree() {
            // æ¸…ç©ºå®¹å™¨
            document.getElementById('tree-container').innerHTML = '';
            
            // æ ¹æ®è§†å›¾æ¨¡å¼è¿‡æ»¤æ•°æ®
            const selectedMode = document.querySelector('input[name="viewMode"]:checked');
            const viewMode = selectedMode ? selectedMode.value : 'both';
            let displayData = treeData;
            
            if (viewMode === 'ast' && treeData.type === 'query_analysis') {
                // ä»…æ˜¾ç¤ºASTéƒ¨åˆ†
                displayData = treeData.children.find(child => child.type === 'select_statement') || treeData;
            } else if (viewMode === 'execution' && treeData.type === 'query_analysis') {
                // ä»…æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’éƒ¨åˆ†
                displayData = treeData.children.find(child => child.type === 'execution_plan') || treeData;
            }
            
            // è®¾ç½®å°ºå¯¸
            const container = document.getElementById('tree-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // åˆ›å»ºSVG
            svg = d3.select('#tree-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            const zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on('zoom', function(event) {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            // åˆ›å»ºä¸»ç»„
            g = svg.append('g')
                .attr('transform', 'translate(50,50)');
            
            // åˆ›å»ºæ ‘å¸ƒå±€
            tree = d3.tree().size([height - 100, width - 200]);
            
            // å¤„ç†æ•°æ®
            root = d3.hierarchy(displayData);
            root.x0 = (height - 100) / 2;
            root.y0 = 0;
            
            // åˆå§‹æŠ˜å é™¤äº†æ ¹èŠ‚ç‚¹çš„æ‰€æœ‰èŠ‚ç‚¹
            if (root.children) {
                root.children.forEach(collapse);
            }
            
            update(root);
        }
        
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }
        
        function expand(d) {
            if (d._children) {
                d.children = d._children;
                d.children.forEach(expand);
                d._children = null;
            }
        }
        
        function update(source) {
            // è®¡ç®—æ–°çš„æ ‘å¸ƒå±€
            const treeData = tree(root);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);
            
            // æ ‡å‡†åŒ–å›ºå®šæ·±åº¦
            nodes.forEach(function(d) {
                d.y = d.depth * 180;
            });
            
            // æ›´æ–°èŠ‚ç‚¹
            const node = g.selectAll('g.node')
                .data(nodes, function(d) { return d.id || (d.id = ++i); });
            
            // è¿›å…¥æ–°èŠ‚ç‚¹
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', function(d) {
                    return 'translate(' + source.y0 + ',' + source.x0 + ')';
                })
                .on('click', click)
                .on('mouseover', mouseover)
                .on('mouseout', mouseout);
            
            // æ·»åŠ åœ†åœˆ
            nodeEnter.append('circle')
                .attr('r', 1e-6)
                .style('fill', function(d) {
                    return d._children ? '#4a90e2' : '#fff';
                });
            
            // æ·»åŠ æ–‡æœ¬
            nodeEnter.append('text')
                .attr('dy', '.35em')
                .attr('x', function(d) {
                    return d.children || d._children ? -13 : 13;
                })
                .attr('text-anchor', function(d) {
                    return d.children || d._children ? 'end' : 'start';
                })
                .text(function(d) {
                    return getNodeLabel(d.data);
                })
                .style('fill-opacity', 1e-6);
            
            // æ›´æ–°ç°æœ‰èŠ‚ç‚¹
            const nodeUpdate = nodeEnter.merge(node);
            
            nodeUpdate.transition()
                .duration(750)
                .attr('transform', function(d) {
                    return 'translate(' + d.y + ',' + d.x + ')';
                });
            
            nodeUpdate.select('circle')
                .attr('r', 8)
                .style('fill', function(d) {
                    return d._children ? '#4a90e2' : '#fff';
                })
                .style('stroke', '#4a90e2')
                .style('stroke-width', '2px')
                .style('display', 'block')
                .attr('cursor', 'pointer');
            
            nodeUpdate.select('text')
                .style('fill-opacity', 1)
                .attr('x', function(d) {
                    return d.children || d._children ? -13 : 13;
                })
                .attr('text-anchor', function(d) {
                    return d.children || d._children ? 'end' : 'start';
                })
                .text(function(d) {
                    return getNodeLabel(d.data);
                })
                .style('display', 'block');
            
            // ç§»é™¤é€€å‡ºçš„èŠ‚ç‚¹
            const nodeExit = node.exit().transition()
                .duration(750)
                .attr('transform', function(d) {
                    return 'translate(' + source.y + ',' + source.x + ')';
                })
                .remove();
            
            nodeExit.select('circle')
                .attr('r', 1e-6);
            
            nodeExit.select('text')
                .style('fill-opacity', 1e-6);
            
            // æ›´æ–°é“¾æ¥
            const link = g.selectAll('path.link')
                .data(links, function(d) { return d.id; });
            
            // è¿›å…¥æ–°é“¾æ¥
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('d', function(d) {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal(o, o);
                });
            
            // æ›´æ–°ç°æœ‰é“¾æ¥
            const linkUpdate = linkEnter.merge(link);
            
            linkUpdate.transition()
                .duration(750)
                .attr('d', function(d) {
                    return diagonal(d, d.parent);
                });
            
            // ç§»é™¤é€€å‡ºçš„é“¾æ¥
            const linkExit = link.exit().transition()
                .duration(750)
                .attr('d', function(d) {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();
            
            // å­˜å‚¨æ—§ä½ç½®ç”¨äºè¿‡æ¸¡
            nodes.forEach(function(d) {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
        
        function diagonal(s, d) {
            const path = `M ${s.y} ${s.x}
                         C ${(s.y + d.y) / 2} ${s.x},
                           ${(s.y + d.y) / 2} ${d.x},
                           ${d.y} ${d.x}`;
            return path;
        }
        
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            if (selectedNode) {
                selectedNode.classed('selected', false);
            }
            selectedNode = d3.select(this);
            selectedNode.classed('selected', true);
            
            // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
            showNodeDetails(d.data);
            
            update(d);
            updateStats();
        }
        
        function mouseover(event, d) {
            // é«˜äº®ç›¸å…³é“¾æ¥
            highlightPath(d);
        }
        
        function mouseout(event, d) {
            // ç§»é™¤é«˜äº®
            g.selectAll('.link').classed('highlighted', false);
        }
        
        function highlightPath(node) {
            // é«˜äº®ä»æ ¹åˆ°å½“å‰èŠ‚ç‚¹çš„è·¯å¾„
            const path = [];
            let current = node;
            while (current.parent) {
                path.push(current);
                current = current.parent;
            }
            
            g.selectAll('.link')
                .classed('highlighted', function(d) {
                    return path.includes(d);
                });
        }
        
        function getNodeLabel(data) {
            let label = '';
            
            // æ˜¾ç¤ºæ‰§è¡Œé¡ºåºï¼ˆä»…å¯¹ä¸»è¦å­å¥æ˜¾ç¤ºï¼‰
            if (data.execution_order && typeof data.execution_order === 'number') {
                label += `[${data.execution_order}] `;
            }
            
            if (data.value) {
                // é™åˆ¶å€¼çš„é•¿åº¦ï¼Œé¿å…æ–‡å­—è¿‡é•¿
                const value = data.value.length > 20 ? data.value.substring(0, 17) + '...' : data.value;
                label += `${data.type}: ${value}`;
            } else {
                // å¯¹äºæ ¹èŠ‚ç‚¹ï¼Œä½¿ç”¨ç®€åŒ–çš„æ ‡ç­¾
                if (data.type === 'SQL_QUERY') {
                    label = 'SQLæŸ¥è¯¢';
                } else {
                    label += data.type || 'unknown';
                }
            }
            
            return label;
        }
        
        // æ–°å¢ï¼šè§£æç”¨æˆ·è¾“å…¥çš„SQL
        async function parseSQL() {
            const sqlInput = document.getElementById('sql-input');
            const sql = sqlInput.value.trim();
            
            if (!sql) {
                alert('è¯·è¾“å…¥SQLè¯­å¥');
                return;
            }
            
            try {
                // å‘é€SQLåˆ°åç«¯è§£æ
                const response = await fetch('/parse-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sql: sql })
                });
                
                if (response.ok) {
                    const astData = await response.json();
                    treeData = astData;
                    initializeTree();
                    updateStats();
                } else {
                    // å¦‚æœåç«¯ä¸æ”¯æŒï¼Œä½¿ç”¨å‰ç«¯ç®€å•è§£æ
                    parseClientSide(sql);
                }
                
            } catch (error) {
                console.log('åç«¯è§£æå¤±è´¥ï¼Œä½¿ç”¨å‰ç«¯è§£æ:', error);
                parseClientSide(sql);
            }
        }
        
        // å‰ç«¯ç®€å•è§£æï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function parseClientSide(sql) {
            try {
                const ast = simpleParseSQL(sql);
                treeData = ast;
                initializeTree();
                updateStats();
            } catch (error) {
                showError(`SQLè§£æå¤±è´¥: ${error.message}`);
            }
        }
        
        // ç®€åŒ–çš„å‰ç«¯SQLè§£æå™¨
        function simpleParseSQL(sql) {
            const tokens = tokenizeSQL(sql);
            return parseTokens(tokens);
        }
        
        function tokenizeSQL(sql) {
            // ç®€å•çš„è¯æ³•åˆ†æ
            const patterns = [
                { type: 'SELECT', pattern: /\bSELECT\b/i },
                { type: 'FROM', pattern: /\bFROM\b/i },
                { type: 'WHERE', pattern: /\bWHERE\b/i },
                { type: 'JOIN', pattern: /\bJOIN\b/i },
                { type: 'LEFT', pattern: /\bLEFT\b/i },
                { type: 'RIGHT', pattern: /\bRIGHT\b/i },
                { type: 'INNER', pattern: /\bINNER\b/i },
                { type: 'ON', pattern: /\bON\b/i },
                { type: 'GROUP', pattern: /\bGROUP\b/i },
                { type: 'BY', pattern: /\bBY\b/i },
                { type: 'HAVING', pattern: /\bHAVING\b/i },
                { type: 'ORDER', pattern: /\bORDER\b/i },
                { type: 'LIMIT', pattern: /\bLIMIT\b/i },
                { type: 'AND', pattern: /\bAND\b/i },
                { type: 'OR', pattern: /\bOR\b/i },
                { type: 'IS', pattern: /\bIS\b/i },
                { type: 'NULL', pattern: /\bNULL\b/i },
                { type: 'NOT', pattern: /\bNOT\b/i },
                { type: 'COUNT', pattern: /\bCOUNT\b/i },
                { type: 'EQ', pattern: /=/ },
                { type: 'GT', pattern: />/ },
                { type: 'LT', pattern: /</ },
                { type: 'COMMA', pattern: /,/ },
                { type: 'LPAREN', pattern: /\(/ },
                { type: 'RPAREN', pattern: /\)/ },
                { type: 'DOT', pattern: /\./ },
                { type: 'SEMICOLON', pattern: /;/ },
                { type: 'STRING', pattern: /'[^']*'/ },
                { type: 'INTEGER', pattern: /\d+/ },
                { type: 'IDENTIFIER', pattern: /[a-zA-Z_][a-zA-Z0-9_]*/ }
            ];
            
            const tokens = [];
            let remaining = sql.trim();
            
            while (remaining.length > 0) {
                // è·³è¿‡ç©ºç™½å­—ç¬¦
                const whitespace = remaining.match(/^\s+/);
                if (whitespace) {
                    remaining = remaining.slice(whitespace[0].length);
                    continue;
                }
                
                let matched = false;
                for (const { type, pattern } of patterns) {
                    const match = remaining.match(new RegExp('^' + pattern.source, pattern.flags));
                    if (match) {
                        tokens.push({ type, value: match[0] });
                        remaining = remaining.slice(match[0].length);
                        matched = true;
                        break;
                    }
                }
                
                if (!matched) {
                    remaining = remaining.slice(1); // è·³è¿‡æ— æ³•è¯†åˆ«çš„å­—ç¬¦
                }
            }
            
            return tokens;
        }
        
        function parseTokens(tokens) {
            if (tokens.length === 0) {
                return { type: 'empty', children: [] };
            }
            
            // ç®€åŒ–è§£æï¼Œåˆ›å»ºåŸºæœ¬çš„ASTç»“æ„
            const root = {
                type: 'SQL_QUERY',
                execution_order: 'FROMâ†’JOINâ†’WHEREâ†’GROUP BYâ†’HAVINGâ†’SELECTâ†’ORDER BYâ†’LIMIT',
                children: []
            };
            
            let i = 0;
            const clauses = [];
            
            // æŸ¥æ‰¾å„ä¸ªå­å¥
            while (i < tokens.length) {
                const token = tokens[i];
                
                if (token.type === 'SELECT') {
                    const selectClause = {
                        type: 'SELECT',
                        execution_order: 6,
                        description: 'SELECT - åˆ—é€‰æ‹©',
                        children: [{ type: 'keyword', value: token.value, children: [] }]
                    };
                    clauses.push(selectClause);
                } else if (token.type === 'FROM') {
                    const fromClause = {
                        type: 'FROM',
                        execution_order: 1,
                        description: 'FROM - ç¡®å®šæ•°æ®æº',
                        children: [{ type: 'keyword', value: token.value, children: [] }]
                    };
                    clauses.push(fromClause);
                } else if (token.type === 'WHERE') {
                    const whereClause = {
                        type: 'WHERE',
                        execution_order: 3,
                        description: 'WHERE - æ•°æ®è¿‡æ»¤',
                        children: [{ type: 'keyword', value: token.value, children: [] }]
                    };
                    clauses.push(whereClause);
                } else if (token.type === 'GROUP') {
                    const groupClause = {
                        type: 'GROUP_BY',
                        execution_order: 4,
                        description: 'GROUP BY - æ•°æ®åˆ†ç»„',
                        children: [{ type: 'keyword', value: 'GROUP BY', children: [] }]
                    };
                    clauses.push(groupClause);
                } else if (token.type === 'HAVING') {
                    const havingClause = {
                        type: 'HAVING',
                        execution_order: 5,
                        description: 'HAVING - åˆ†ç»„è¿‡æ»¤',
                        children: [{ type: 'keyword', value: token.value, children: [] }]
                    };
                    clauses.push(havingClause);
                }
                
                i++;
            }
            
            // æŒ‰æ‰§è¡Œé¡ºåºæ’åº
            clauses.sort((a, b) => (a.execution_order || 0) - (b.execution_order || 0));
            root.children = clauses;
            
            return root;
        }
        
        function showNodeDetails(data) {
            const panel = document.getElementById('info-panel');
            const details = document.getElementById('node-details');
            
            let html = '';
            
            // åŸºæœ¬ä¿¡æ¯
            html += `<div class="info-item">
                        <span class="info-label">ç±»å‹:</span>
                        <span class="info-value">${data.type || 'unknown'}</span>
                     </div>`;
            
            if (data.value) {
                html += `<div class="info-item">
                            <span class="info-label">å€¼:</span>
                            <span class="info-value">${data.value}</span>
                         </div>`;
            }
            
            // æ‰§è¡Œé¡ºåºä¿¡æ¯
            if (data.execution_order) {
                html += `<div class="info-item">
                            <span class="info-label">æ‰§è¡Œé¡ºåº:</span>
                            <span class="info-value">${data.execution_order}</span>
                         </div>`;
            }
            
            // æè¿°ä¿¡æ¯
            if (data.description) {
                html += `<div class="info-item">
                            <span class="info-label">è¯´æ˜:</span>
                            <span class="info-value">${data.description}</span>
                         </div>`;
            }
            
            if (data.data_type) {
                html += `<div class="info-item">
                            <span class="info-label">æ•°æ®ç±»å‹:</span>
                            <span class="info-value">${data.data_type}</span>
                         </div>`;
            }
            
            if (data.operator) {
                html += `<div class="info-item">
                            <span class="info-label">æ“ä½œç¬¦:</span>
                            <span class="info-value">${data.operator}</span>
                         </div>`;
            }
            
            // å­èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
            if (data.children && data.children.length > 0) {
                html += `<div class="info-item">
                            <span class="info-label">å­èŠ‚ç‚¹:</span>
                            <span class="info-value">${data.children.length} ä¸ª</span>
                         </div>`;
                
                // æ˜¾ç¤ºå­èŠ‚ç‚¹ç±»å‹
                const childTypes = data.children.map(child => child.type || 'unknown').join(', ');
                html += `<div class="info-item">
                            <span class="info-label">åŒ…å«:</span>
                            <span class="info-value">${childTypes}</span>
                         </div>`;
            }
            
            // SQLè¯­æ³•ä½œç”¨è¯´æ˜
            const syntaxExplanation = getSyntaxExplanation(data.type);
            if (syntaxExplanation) {
                html += `<div class="info-item">
                            <span class="info-label">è¯­æ³•ä½œç”¨:</span>
                            <span class="info-value">${syntaxExplanation}</span>
                         </div>`;
            }
            
            details.innerHTML = html;
            panel.style.display = 'block';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('selected-node').textContent = data.type || 'unknown';
        }
        
        function getSyntaxExplanation(nodeType) {
            const explanations = {
                'SQL_QUERY': 'å®Œæ•´çš„SQLæŸ¥è¯¢è¯­å¥ï¼ŒåŒ…å«æ‰€æœ‰å­å¥',
                'SELECT': 'é€‰æ‹©è¦è¿”å›çš„åˆ—ï¼Œå†³å®šæŸ¥è¯¢ç»“æœçš„ç»“æ„',
                'FROM': 'æŒ‡å®šæ•°æ®æºè¡¨ï¼Œæ˜¯æŸ¥è¯¢çš„èµ·ç‚¹',
                'WHERE': 'è¿‡æ»¤è¡Œæ•°æ®ï¼Œåªè¿”å›æ»¡è¶³æ¡ä»¶çš„è®°å½•',
                'GROUP_BY': 'æŒ‰æŒ‡å®šåˆ—åˆ†ç»„ï¼Œç”¨äºèšåˆè®¡ç®—',
                'HAVING': 'è¿‡æ»¤åˆ†ç»„åçš„ç»“æœï¼Œç±»ä¼¼WHEREä½†ä½œç”¨äºåˆ†ç»„',
                'ORDER_BY': 'å¯¹ç»“æœè¿›è¡Œæ’åº',
                'LIMIT': 'é™åˆ¶è¿”å›çš„è®°å½•æ•°é‡',
                'JOIN': 'è¿æ¥å¤šä¸ªè¡¨ï¼Œåˆå¹¶ç›¸å…³æ•°æ®',
                'LEFT': 'LEFT JOINçš„ä¸€éƒ¨åˆ†ï¼Œä¿ç•™å·¦è¡¨æ‰€æœ‰è®°å½•',
                'RIGHT': 'RIGHT JOINçš„ä¸€éƒ¨åˆ†ï¼Œä¿ç•™å³è¡¨æ‰€æœ‰è®°å½•',
                'INNER': 'INNER JOINçš„ä¸€éƒ¨åˆ†ï¼Œåªä¿ç•™åŒ¹é…çš„è®°å½•',
                'keyword': 'SQLå…³é”®å­—ï¼Œå®šä¹‰æŸ¥è¯¢çš„ç»“æ„å’Œé€»è¾‘',
                'identifier': 'æ ‡è¯†ç¬¦ï¼Œå¦‚è¡¨åã€åˆ—åç­‰',
                'literal': 'å­—é¢é‡å€¼ï¼Œå¦‚å­—ç¬¦ä¸²ã€æ•°å­—ç­‰',
                'operator': 'æ“ä½œç¬¦ï¼Œç”¨äºæ¯”è¾ƒå’Œé€»è¾‘è¿ç®—',
                'function': 'SQLå‡½æ•°ï¼Œå¦‚COUNTã€SUMç­‰èšåˆå‡½æ•°'
            };
            
            return explanations[nodeType] || null;
        }
        
        function closeInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
            if (selectedNode) {
                selectedNode.classed('selected', false);
                selectedNode = null;
            }
            document.getElementById('selected-node').textContent = 'æ— ';
        }
        
        function expandAll() {
            if (!root) return;
            
            function expandNode(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expandNode);
                }
            }
            
            expandNode(root);
            // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
            tree(root);
            update(root);
            updateStats();
        }
        
        function collapseAll() {
            if (!root) return;
            
            function collapseNode(d) {
                if (d.children) {
                    // å…ˆé€’å½’å¤„ç†å­èŠ‚ç‚¹
                    d.children.forEach(collapseNode);
                    // ç„¶åæŠ˜å å½“å‰èŠ‚ç‚¹
                    d._children = d.children;
                    d.children = null;
                }
            }
            
            if (root.children) {
                root.children.forEach(collapseNode);
            }
            // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
            tree(root);
            update(root);
            updateStats();
        }
        
        function resetZoom() {
            if (svg) {
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 3])
                    .on('zoom', function(event) {
                        g.attr('transform', event.transform);
                    });
                
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity
                );
            }
        }
        
        let detailsVisible = true;
        
        function toggleDetails() {
            const infoPanel = document.getElementById('info-panel');
            const button = document.querySelector('button[onclick="toggleDetails()"]');
            
            if (infoPanel.style.display === 'none') {
                infoPanel.style.display = 'block';
                button.textContent = 'éšè—è¯¦æƒ…é¢æ¿';
                detailsVisible = true;
            } else {
                infoPanel.style.display = 'none';
                button.textContent = 'æ˜¾ç¤ºè¯¦æƒ…é¢æ¿';
                detailsVisible = false;
            }
        }
        
        function updateStats() {
            if (!root) return;
            
            // è®¡ç®—èŠ‚ç‚¹æ€»æ•°
            let nodeCount = 0;
            function countNodes(node) {
                nodeCount++;
                if (node.children) {
                    node.children.forEach(countNodes);
                }
                if (node._children) {
                    node._children.forEach(countNodes);
                }
            }
            countNodes(root);
            
            // è®¡ç®—æœ€å¤§æ·±åº¦
            let maxDepth = 0;
            function calculateDepth(node, depth = 0) {
                maxDepth = Math.max(maxDepth, depth);
                if (node.children) {
                    node.children.forEach(child => calculateDepth(child, depth + 1));
                }
                if (node._children) {
                    node._children.forEach(child => calculateDepth(child, depth + 1));
                }
            }
            calculateDepth(root);
            
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('depth-count').textContent = maxDepth;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <strong>è§£æé”™è¯¯:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; cursor: pointer;">Ã—</button>
            `;
            
            // æ·»åŠ é”™è¯¯æ ·å¼
            errorDiv.style.cssText = `
                background: #dc3545;
                color: white;
                padding: 10px 15px;
                margin: 10px 0;
                border-radius: 4px;
                position: relative;
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // é¡µé¢åŠ è½½æ—¶è®¾ç½®ç¤ºä¾‹SQL
        window.addEventListener('DOMContentLoaded', function() {
            const sqlInput = document.getElementById('sql-input');
            if (sqlInput) {
                sqlInput.value = `SELECT id, name FROM users 
LEFT JOIN orders ON users.id = orders.user_id 
WHERE age > 18 AND name = 'å¼ ä¸‰' AND orders.id IS NULL 
GROUP BY id, name 
HAVING count(*) = 0;`;
            }
        })
        
        // è§†å›¾æ¨¡å¼åˆ‡æ¢å‡½æ•°
         function switchViewMode() {
             const selectedMode = document.querySelector('input[name="viewMode"]:checked');
             if (!selectedMode) return;
             
             const viewMode = selectedMode.value;
             
             // æ ¹æ®é€‰æ‹©çš„æ¨¡å¼è°ƒæ•´æ˜¾ç¤º
             switch(viewMode) {
                 case 'both':
                     // æ˜¾ç¤ºASTå’Œæ‰§è¡Œè®¡åˆ’
                     if (treeData) {
                         initializeTree();
                     }
                     break;
                 case 'ast':
                     // ä»…æ˜¾ç¤ºAST
                     if (treeData) {
                         initializeTree();
                     }
                     break;
                 case 'execution':
                     // ä»…æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’
                     if (treeData) {
                         initializeTree();
                     }
                     break;
                 default:
                     if (treeData) {
                         initializeTree();
                     }
             }
         }
        
        // æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’è§†å›¾
        function showExecutionPlan() {
            const container = document.getElementById('tree-container');
            container.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>SQLæ‰§è¡Œè®¡åˆ’è§†å›¾</h3>
                    <p>æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œå°†æ˜¾ç¤ºSQLè¯­å¥çš„æ‰§è¡Œé¡ºåºå’Œæ€§èƒ½åˆ†æ</p>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: left;">
                        <h4>å…¸å‹SQLæ‰§è¡Œé¡ºåºï¼š</h4>
                        <ol>
                            <li><strong>FROM</strong> - ç¡®å®šæ•°æ®æºè¡¨</li>
                            <li><strong>JOIN</strong> - è¿æ¥ç›¸å…³è¡¨</li>
                            <li><strong>WHERE</strong> - è¿‡æ»¤è¡Œæ•°æ®</li>
                            <li><strong>GROUP BY</strong> - æ•°æ®åˆ†ç»„</li>
                            <li><strong>HAVING</strong> - åˆ†ç»„åè¿‡æ»¤</li>
                            <li><strong>SELECT</strong> - é€‰æ‹©åˆ—</li>
                            <li><strong>ORDER BY</strong> - ç»“æœæ’åº</li>
                            <li><strong>LIMIT</strong> - é™åˆ¶ç»“æœæ•°é‡</li>
                        </ol>
                    </div>
                </div>
            `;
        }
        
        // å…¨å±€å˜é‡ç”¨äºèŠ‚ç‚¹ID
        let i = 0;
        
        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', function() {
            if (svg) {
                const container = document.getElementById('tree-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                svg.attr('width', width).attr('height', height);
                tree.size([height - 100, width - 200]);
                
                if (root) {
                    update(root);
                }
            }
        });
    </script>
</body>
</html>